<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OBAS PLAN TOOL 17 Jul 2025</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@1.0.0/css/bulma.min.css">
  <link rel="stylesheet" href="blot.css">
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>
</head>

<body class="section">
  <div class="container" x-data="chunkApp()" x-init="init()">

    <!-- Fragment Output Popup -->
    <div class="fragment-popup" x-show="showFragmentPopup">
      <div class="fragment-popup-header">
        <h4 class="fragment-popup-title">Fragment Output</h4>
        <div class="fragment-popup-close" @click="closeFragmentPopup">CLOSE</div>

      </div>

      <div class="fragment-popup-content" id="fragmentContentContainer"></div>

    </div>

    <nav class="level mb-4">
      <div class="level-left">
        <div class="level-item">
          <h1 class="mb-0 ml-2" style="font-size: 1.5rem;">OBA 19/6</h1>
        </div>
      </div>
      <div class="level-right">
        <div class="level-item" x-show="!user">
          <button class="button is-light" @click="signInWithGoogle">
            Sign in with Google
          </button>
        </div>
        <div class="level-item" x-show="user" style="display: flex; align-items: center;">
          <button class="button is-small is-danger" @click="signOut">Logout</button>
        </div>
      </div>
      <!-- User info chiclet -->
      <div class="user-info-chiclet" x-show="user">
        <div class="has-text-weight-bold" x-text="displayName"></div>
        <div class="has-text-grey-dark" x-text="displayEmail"></div>
      </div>
    </nav>
    <div class="box" style="display: flex; flex-direction: row; gap: 2vw;">
      <div style="width: 60vw; min-width: 300px;">
        <table class="table is-fullwidth is-striped is-hoverable">
          <thead>
            <tr>
              <th class="is-narrow" style="width:5vw; min-width:2.5em; text-align:center;">#</th>
              <th>Content</th>
              <th class="is-narrow" style="width:5vw; min-width:2.5em; text-align:center;">Select</th>
              <th class="is-narrow" style="width:8vw; min-width:5em; text-align:center;">Verbosity</th>
              <th class="is-narrow" style="width:5vw; min-width:2.5em; text-align:center;">Order</th>
              <th class="is-narrow" style="width:5vw; min-width:2.5em; text-align:center;">Delete</th>
            </tr>
          </thead>
          <tbody>
            <template x-for="(chunk, idx) in chunks" :key="chunk.chunk_id">
              <tr
                :class="{'chunk-row': true, 'selected': chunk.chunk_select, 'unselected': !chunk.chunk_select, 'latest-row': chunk.chunk_id === latestRowId}">
                <td class="is-narrow" style="width:5vw; min-width:2.5em; text-align:center;" x-text="chunk.chunk_index">
                </td>
                <td style="max-width: 400px; word-break: break-all; cursor: pointer;"
                  :contenteditable="editingChunkId === chunk.chunk_id" @click="enableEdit(chunk)"
                  @blur="saveEdit(chunk, $event)" @keydown.enter.prevent="saveEdit(chunk, $event)"
                  @keydown.esc="cancelEdit()" x-text="chunk.chunk_content"
                  :tabindex="editingChunkId === chunk.chunk_id ? 0 : -1"></td>
                <td class="is-narrow" style="width:5vw; min-width:2.5em; text-align:center;">
                  <input type="checkbox" :checked="chunk.chunk_select" @change="toggleSelect(chunk)">
                </td>
                <td class="is-narrow" style="width:8vw; min-width:5em; text-align:center;">
                  <div class="slider-container">
                    <input type="range" class="verbosity-slider" min="1" max="10" step="1" :value="chunk.verbosity || 5"
                      @change="setVerbosity(chunk, $event.target.value)">
                  </div>
                </td>
                <td class="is-narrow" style="width:5vw; min-width:2.5em; text-align:center;">
                  <div class="buttons has-addons is-centered">
                    <button class="button is-small move-btn" style="padding:0 0.3em;" :disabled="idx === 0"
                      @click="moveChunk(idx, -1)">&#8593;</button>
                    <button class="button is-small move-btn" style="padding:0 0.3em;"
                      :disabled="idx === chunks.length - 1" @click="moveChunk(idx, 1)">&#8595;</button>
                  </div>
                </td>
                <td class="is-narrow" style="width:5vw; min-width:2.5em; text-align:center;">
                  <button class="delete-x" @click="deleteChunk(chunk)">âœ•</button>
                </td>
              </tr>
            </template>
            <!-- Shadow row for new insert -->
            <tr x-show="!insertingNew" class="shadow-row" @click="startInsertRow()">
              <td class="is-narrow" style="width:5vw; min-width:2.5em; text-align:center; color: #bbb;">+</td>
              <td colspan="5" style="color: #bbb; cursor: pointer;">click to insert new</td>
            </tr>
            <tr x-show="insertingNew" class="shadow-row">
              <td class="is-narrow"
                style="width:5vw; min-width:2.5em; text-align:center; color: #00ff88; background: #111;">+</td>
              <td colspan="5">
                <div contenteditable="true" class="insert-editable green-black-edit" x-ref="insertInput"
                  @keydown.enter.prevent="saveInsertRow($event)" @keydown.esc="cancelInsertRow()"
                  style="outline: none; min-height: 1.5em; background: #111; color: #00ff88; border-radius: 4px; padding: 0.2em 0.5em;">
                </div>
              </td>
            </tr>
          </tbody>
        </table>
        <div x-show="chunks.length === 0" class="has-text-grey">No chunks yet.</div>
      </div>
      <div style="flex: 1; min-width: 200px; border-radius: 8px; padding: 2vw; box-shadow: 0 2px 8px #ffe06633;">
        <h2 style="font-size: 1.1rem; font-weight: normal;">output generated: </h2>
        <div style="display: flex; flex-direction: row; align-items: center; gap: 1em; margin-bottom: 0.5em;">
          <div id="status" x-text="projectStatus"></div>
          <div>
            <span class="has-text-grey">last action: </span>
            <span x-text="formatActionTime(projectActionTime)" style="font-size: 60%"></span>
          </div>
        </div>
        <div style="width: 15vw; min-width: 200px; display: flex; flex-direction: column; gap: 1.5em;">
          <div>
            <h3 class="subtitle is-6">obas text:</h3>
            <pre id="obas_text" x-text="obasText"
              style="width: 15vw; min-width: 200px; height: 15vh; min-height: 80px; max-height: 40vh; overflow: auto; background: #222; color: #ffe066; border-radius: 6px; padding: 1em;"></pre>
            <div style="margin-top: 1em; text-align: right;">
              <button class="button is-warning" @click="submitObas()">Submit obas</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="blot.js"></script>
</body>

</html>